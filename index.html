<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Group Locker</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        .card-hover:hover {
            transform: translateY(-5px);
            transition: all 0.3s ease;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-live {
            background-color: #28a745;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .preview-box {
            background-color: #e9f7ff;
            border-left: 4px solid #17a2b8;
        }
        .monitoring-active {
            background-color: #f0fff4;
            border-left: 4px solid #28a745;
        }
        .warning-box {
            background-color: #fffaf0;
            border-left: 4px solid #ffc107;
        }
        .danger-box {
            background-color: #fff5f5;
            border-left: 4px solid #dc3545;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .hero-section {
            background: linear-gradient(135deg, #0062e6 0%, #33aeff 100%);
            color: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #0d6efd;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4 main-container">
        <div id="root"></div>
    </div>

    <!-- React & ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Use axios from CDN instead of importing it
        const axios = window.axios;

        const API_BASE = 'http://localhost:3000/api';

        function FacebookGroupLocker() {
            const [sessionId, setSessionId] = useState(localStorage.getItem('fb_session') || '');
            const [groups, setGroups] = useState([]);
            const [selectedGroup, setSelectedGroup] = useState('');
            const [nickname, setNickname] = useState('');
            const [groupName, setGroupName] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [isMonitoring, setIsMonitoring] = useState(false);
            const [monitoringStatus, setMonitoringStatus] = useState(null);

            // Check session status on load
            useEffect(() => {
                if (sessionId) {
                    checkSessionStatus();
                }
            }, [sessionId]);

            // Memoize the checkMonitoringStatus function to prevent unnecessary recreations
            const checkMonitoringStatus = useCallback(async () => {
                if (!sessionId || !selectedGroup) return;
                
                try {
                    const response = await axios.get(`${API_BASE}/monitoring-status/${sessionId}/${selectedGroup}`);
                    if (response.data.active) {
                        setMonitoringStatus(response.data);
                        setIsMonitoring(true);
                    } else {
                        setIsMonitoring(false);
                        setMonitoringStatus(null);
                    }
                } catch (error) {
                    console.error('Error checking monitoring status:', error);
                    setIsMonitoring(false);
                    setMonitoringStatus(null);
                }
            }, [sessionId, selectedGroup]);

            // Check monitoring status every 10 seconds
            useEffect(() => {
                let interval;
                if (isMonitoring && selectedGroup) {
                    interval = setInterval(checkMonitoringStatus, 10000);
                    checkMonitoringStatus(); // Initial check
                }
                return () => {
                    if (interval) clearInterval(interval);
                };
            }, [isMonitoring, selectedGroup, checkMonitoringStatus]);

            const checkSessionStatus = async () => {
                try {
                    await axios.get(`${API_BASE}/session/${sessionId}/status`);
                    loadGroups();
                } catch (error) {
                    setSessionId('');
                    localStorage.removeItem('fb_session');
                    setMessage('âŒ Session expired. Please log in again.');
                }
            };

            const loadGroups = async () => {
                try {
                    const response = await axios.get(`${API_BASE}/groups/${sessionId}`);
                    setGroups(response.data.groups);
                } catch (error) {
                    setMessage(`âŒ Failed to load groups: ${error.response?.data?.error || error.message}`);
                }
            };

            const handleLogin = async (event) => {
                event.preventDefault();
                setLoading(true);
                setMessage('');

                const formData = new FormData(event.target);

                try {
                    const response = await axios.post(`${API_BASE}/login`, formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });

                    const { sessionId: newSessionId } = response.data;
                    setSessionId(newSessionId);
                    localStorage.setItem('fb_session', newSessionId);
                    setMessage('âœ… Logged in successfully!');
                    loadGroups();
                    
                } catch (error) {
                    setMessage(`âŒ Login failed: ${error.response?.data?.error || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleApplyAndLock = async () => {
                if (!selectedGroup) {
                    setMessage('âŒ Please select a group');
                    return;
                }

                if (!nickname.trim() && !groupName.trim()) {
                    setMessage('âŒ Please enter at least a nickname or group name');
                    return;
                }

                setLoading(true);
                setMessage('ðŸ”„ Applying changes and starting protection...');

                try {
                    // Step 1: Apply changes
                    const changeResponse = await axios.post(`${API_BASE}/change-all`, {
                        sessionId,
                        groupId: selectedGroup,
                        nickname: nickname.trim() || undefined,
                        groupName: groupName.trim() || undefined
                    });

                    // Step 2: Start monitoring
                    const monitorResponse = await axios.post(`${API_BASE}/start-monitoring`, {
                        sessionId,
                        groupId: selectedGroup,
                        lockNickname: nickname.trim() || null,
                        lockGroupName: groupName.trim() || null
                    });

                    setIsMonitoring(true);
                    setMessage(`âœ… Changes applied and protection activated! Group is now locked ðŸ”’`);
                    
                    // Update group name in local state if changed
                    if (groupName.trim()) {
                        setGroups(groups.map(group => 
                            group.id === selectedGroup 
                                ? { ...group, name: groupName.trim() }
                                : group
                        ));
                    }

                } catch (error) {
                    setMessage(`âŒ Failed: ${error.response?.data?.error || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleStopProtection = async () => {
                if (!selectedGroup) return;

                setLoading(true);
                setMessage('ðŸ”„ Stopping protection...');

                try {
                    await axios.post(`${API_BASE}/stop-monitoring`, {
                        sessionId,
                        groupId: selectedGroup
                    });

                    setIsMonitoring(false);
                    setMonitoringStatus(null);
                    setMessage('ðŸ”“ Protection stopped - group is now unlocked');
                    
                } catch (error) {
                    setMessage(`âŒ Failed to stop protection: ${error.response?.data?.error || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                // Stop monitoring first
                if (isMonitoring && selectedGroup) {
                    try {
                        await axios.post(`${API_BASE}/stop-monitoring`, {
                            sessionId,
                            groupId: selectedGroup
                        });
                    } catch (error) {
                        console.error('Error stopping monitoring during logout:', error);
                    }
                }

                try {
                    await axios.post(`${API_BASE}/logout/${sessionId}`);
                } catch (error) {
                    console.error('Error during logout:', error);
                }
                
                setSessionId('');
                setGroups([]);
                setSelectedGroup('');
                setNickname('');
                setGroupName('');
                setIsMonitoring(false);
                setMonitoringStatus(null);
                localStorage.removeItem('fb_session');
                setMessage('ðŸ‘‹ Logged out successfully');
            };

            const selectedGroupData = groups.find(g => g.id === selectedGroup);

            if (!sessionId) {
                return (
                    <div className="row justify-content-center mt-5">
                        <div className="col-md-8">
                            <div className="hero-section text-center">
                                <h1 className="display-4 fw-bold">
                                    <i className="bi bi-shield-lock-fill me-2"></i>
                                    Facebook Group Locker
                                </h1>
                                <p className="lead">Secure your Facebook groups by locking nicknames and group names permanently</p>
                            </div>
                            
                            <div className="row mt-4">
                                <div className="col-md-6 mb-4">
                                    <div className="card h-100 card-hover">
                                        <div className="card-body text-center">
                                            <div className="feature-icon">
                                                <i className="bi bi-person-lock"></i>
                                            </div>
                                            <h5 className="card-title">Nickname Protection</h5>
                                            <p className="card-text">Lock all member nicknames to a specific value and prevent changes.</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="col-md-6 mb-4">
                                    <div className="card h-100 card-hover">
                                        <div className="card-body text-center">
                                            <div className="feature-icon">
                                                <i className="bi bi-chat-square-text"></i>
                                            </div>
                                            <h5 className="card-title">Group Name Protection</h5>
                                            <p className="card-text">Lock your group name to prevent unauthorized changes.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="card shadow">
                                <div className="card-body p-5">
                                    <h3 className="card-title text-center mb-4">Login to Get Started</h3>
                                    
                                    <form onSubmit={handleLogin}>
                                        <div className="mb-3">
                                            <label className="form-label">
                                                <i className="bi bi-file-earmark-arrow-up me-1"></i>
                                                Upload AppState.json File:
                                            </label>
                                            <input
                                                type="file"
                                                name="appstate"
                                                accept=".json"
                                                className="form-control"
                                                required
                                            />
                                            <div className="form-text">
                                                <i className="bi bi-lightbulb me-1"></i>
                                                Get your Facebook cookies using c3c-fbstate browser extension
                                            </div>
                                        </div>
                                        
                                        <button
                                            type="submit"
                                            disabled={loading}
                                            className="btn btn-primary w-100 py-2 mt-3"
                                        >
                                            {loading ? (
                                                <>
                                                    <span className="spinner-border spinner-border-sm me-2" role="status"></span>
                                                    Logging in...
                                                </>
                                            ) : (
                                                <>
                                                    <i className="bi bi-key me-2"></i>
                                                    Login to Facebook
                                                </>
                                            )}
                                        </button>
                                    </form>

                                    {message && (
                                        <div className="alert alert-info mt-4" role="alert">
                                            {message}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container-fluid">
                    <div className="row mb-4">
                        <div className="col">
                            <div className="d-flex justify-content-between align-items-center py-3 border-bottom">
                                <div>
                                    <h1 className="h3 mb-0">
                                        <i className="bi bi-shield-lock text-primary me-2"></i>
                                        Facebook Group Locker
                                    </h1>
                                    <p className="text-muted mb-0">Set it once, lock it forever!</p>
                                </div>
                                <button
                                    onClick={handleLogout}
                                    className="btn btn-outline-danger"
                                >
                                    <i className="bi bi-box-arrow-right me-1"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="row">
                        <div className="col-lg-10 mx-auto">
                            <div className="mb-4">
                                <label className="form-label fw-bold">
                                    <i className="bi bi-people-fill me-1"></i>
                                    Select Group to Control:
                                </label>
                                <select
                                    value={selectedGroup}
                                    onChange={(e) => {
                                        setSelectedGroup(e.target.value);
                                        setIsMonitoring(false);
                                        setMonitoringStatus(null);
                                    }}
                                    className="form-select form-select-lg"
                                    disabled={isMonitoring}
                                >
                                    <option value="">Choose a group...</option>
                                    {groups.map(group => (
                                        <option key={group.id} value={group.id}>
                                            {group.name} ({group.memberCount} members)
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {/* Monitoring Status */}
                            {isMonitoring && monitoringStatus && (
                                <div className="card monitoring-active mb-4">
                                    <div className="card-body">
                                        <div className="d-flex justify-content-between align-items-center mb-2">
                                            <h5 className="card-title text-success mb-0">
                                                <i className="bi bi-shield-check me-2"></i>
                                                PROTECTION ACTIVE
                                            </h5>
                                            <div className="d-flex align-items-center">
                                                <span className="status-indicator status-live"></span>
                                                <small className="text-success">Live</small>
                                            </div>
                                        </div>
                                        <div className="row">
                                            <div className="col-md-6">
                                                <p className="mb-1">
                                                    <i className="bi bi-clock me-2"></i>
                                                    <strong>Running:</strong> {monitoringStatus.uptime}
                                                </p>
                                                <p className="mb-1">
                                                    <i className="bi bi-x-circle me-2"></i>
                                                    <strong>Violations blocked:</strong> {monitoringStatus.violations}
                                                </p>
                                                <p className="mb-1">
                                                    <i className="bi bi-person me-2"></i>
                                                    <strong>Locked nickname:</strong> {monitoringStatus.lockNickname || 'Not locked'}
                                                </p>
                                            </div>
                                            <div className="col-md-6">
                                                <p className="mb-1">
                                                    <i className="bi bi-tag me-2"></i>
                                                    <strong>Locked group name:</strong> {monitoringStatus.lockGroupName || 'Not locked'}
                                                </p>
                                                <p className="mb-1">
                                                    <i className="bi bi-people me-2"></i>
                                                    <strong>Protected members:</strong> {monitoringStatus.memberCount}
                                                </p>
                                                <p className="mb-1">
                                                    <i className="bi bi-eye me-2"></i>
                                                    <strong>Last check:</strong> {monitoringStatus.lastCheck}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Configuration Form */}
                            {!isMonitoring && (
                                <div className="card mb-4">
                                    <div className="card-header bg-light">
                                        <h5 className="card-title mb-0">
                                            <i className="bi bi-gear me-2"></i>
                                            Lock Configuration
                                        </h5>
                                    </div>
                                    <div className="card-body">
                                        <div className="mb-3">
                                            <label className="form-label">
                                                <i className="bi bi-person me-1"></i>
                                                Lock All Nicknames To:
                                            </label>
                                            <input
                                                type="text"
                                                value={nickname}
                                                onChange={(e) => setNickname(e.target.value)}
                                                placeholder="e.g., Student, Team Member, Participant"
                                                className="form-control"
                                                maxLength={50}
                                            />
                                            <div className="form-text">
                                                <i className="bi bi-lock me-1"></i>
                                                Anyone who tries to change nicknames will be instantly reverted
                                            </div>
                                        </div>

                                        <div className="mb-4">
                                            <label className="form-label">
                                                <i className="bi bi-tag me-1"></i>
                                                Lock Group Name To:
                                            </label>
                                            <input
                                                type="text"
                                                value={groupName}
                                                onChange={(e) => setGroupName(e.target.value)}
                                                placeholder="e.g., Study Group 2024, Project Team"
                                                className="form-control"
                                                maxLength={100}
                                            />
                                            <div className="form-text">
                                                <i className="bi bi-lock me-1"></i>
                                                Group name changes will be instantly reverted
                                            </div>
                                        </div>

                                        {/* Preview */}
                                        {selectedGroupData && (nickname.trim() || groupName.trim()) && (
                                            <div className="preview-box p-3 rounded mb-4">
                                                <h6 className="mb-2">
                                                    <i className="bi bi-eye me-2"></i>
                                                    Lock Preview:
                                                </h6>
                                                {groupName.trim() && (
                                                    <p className="mb-1">
                                                        <i className="bi bi-tag me-2"></i>
                                                        Group name locked to: "<strong>{groupName}</strong>"
                                                    </p>
                                                )}
                                                {nickname.trim() && (
                                                    <p className="mb-2">
                                                        <i className="bi bi-people me-2"></i>
                                                        All {selectedGroupData.memberCount} members locked to: "<strong>{nickname}</strong>"
                                                    </p>
                                                )}
                                                <div className="alert alert-primary mt-2 mb-0 py-2">
                                                    <i className="bi bi-lightning me-2"></i>
                                                    Bot will run 24/7 and block ANY changes by other members
                                                </div>
                                            </div>
                                        )}

                                        <button
                                            onClick={handleApplyAndLock}
                                            disabled={loading || !selectedGroup || (!nickname.trim() && !groupName.trim())}
                                            className="btn btn-danger w-100 py-3 fw-bold"
                                        >
                                            {loading ? (
                                                <>
                                                    <span className="spinner-border spinner-border-sm me-2" role="status"></span>
                                                    Applying & Activating...
                                                </>
                                            ) : (
                                                <>
                                                    <i className="bi bi-lock-fill me-2"></i>
                                                    APPLY & LOCK FOREVER
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Stop Protection Button */}
                            {isMonitoring && (
                                <div className="mb-4">
                                    <button
                                        onClick={handleStopProtection}
                                        disabled={loading}
                                        className="btn btn-secondary w-100 py-3 fw-bold"
                                    >
                                        {loading ? (
                                            <>
                                                <span className="spinner-border spinner-border-sm me-2" role="status"></span>
                                                Stopping...
                                            </>
                                        ) : (
                                            <>
                                                <i className="bi bi-unlock me-2"></i>
                                                STOP PROTECTION
                                            </>
                                        )}
                                    </button>
                                </div>
                            )}

                            {/* Status Messages */}
                            {message && (
                                <div className="alert alert-info" role="alert">
                                    {message}
                                </div>
                            )}

                            {/* Info Section */}
                            <div className="card warning-box mb-4">
                                <div className="card-body">
                                    <h5 className="card-title">
                                        <i className="bi bi-robot me-2"></i>
                                        How Protection Works:
                                    </h5>
                                    <ul className="list-group list-group-flush">
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-lightning me-2"></i>
                                            <strong>Instant blocking:</strong> Any change is reverted within 1-2 seconds
                                        </li>
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-eye me-2"></i>
                                            <strong>24/7 monitoring:</strong> Bot watches the group continuously
                                        </li>
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-person-plus me-2"></i>
                                            <strong>New members:</strong> Automatically get the locked nickname
                                        </li>
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-arrow-repeat me-2"></i>
                                            <strong>Periodic checks:</strong> Ensures everything stays locked every 30 seconds
                                        </li>
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-graph-up me-2"></i>
                                            <strong>Violation tracking:</strong> Counts how many attempts were blocked
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            {/* Warning */}
                            <div className="card danger-box">
                                <div className="card-body">
                                    <h5 className="card-title">
                                        <i className="bi bi-exclamation-triangle me-2"></i>
                                        Important Notes:
                                    </h5>
                                    <ul className="list-group list-group-flush">
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-power me-2"></i>
                                            <strong>Keep this tab open:</strong> Closing stops the protection
                                        </li>
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-wifi me-2"></i>
                                            <strong>Requires internet:</strong> Bot needs connection to work
                                        </li>
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-person-check me-2"></i>
                                            <strong>You maintain control:</strong> Only you can stop the protection
                                        </li>
                                        <li className="list-group-item bg-transparent">
                                            <i className="bi bi-shield-check me-2"></i>
                                            <strong>Use responsibly:</strong> Inform group members about the lock
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FacebookGroupLocker />);
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
